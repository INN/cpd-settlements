!function(){var a=jQuery,b=Backbone.Router.extend({routes:{search:"cases","search/":"cases","":"cases","search/officers":"officers","search/cases":"cases","search/officers/":"officers","search/cases/":"cases","case/*path":"case_detail","officer/*path":"officer_detail"},initialize:function(){return this.caseCollection=new d(cases_json),this.caseList=new h({el:"#case-list-view"}),this.officerCollection=new f(officers_json),this.officerList=new i({el:"#officer-list-view"}),this.searchSelector=new n({el:"#tabs",cases:this.caseCollection,caseList:this.caseList,officers:this.officerCollection,officerList:this.officerList}),Backbone.Router.prototype.initialize.apply(this,arguments),this},officers:function(){return a(".case-list").hide(),this.searchSelector.goToTab("officers"),a(".officer-list, .results-wrapper-inner").show(),a(".search-statement-wrapper").hide(),!1},officer_detail:function(){return a(".case-list").hide(),this.searchSelector.goToTab("officers",!0),a(".officer-list, .results-wrapper-inner").hide(),a(".search-statement-wrapper").hide(),!1},cases:function(){return a(".officer-list").hide(),this.searchSelector.goToTab("cases"),a(".case-list, .results-wrapper-inner").show(),a(".search-statement-wrapper").show(),!1},case_detail:function(){return a(".officer-list").hide(),this.searchSelector.goToTab("cases",!0),a(".case-list, .results-wrapper-inner").hide(),a(".search-statement-wrapper").hide(),!1}}),c=Backbone.Model.extend({}),d=Backbone.Collection.extend({model:c,comparator:function(a,b){return this.hightolow(a,b)},hightolow:function(a,b){var c=Number(a.get("total_payments")),d=Number(b.get("total_payments"));return d>c?1:c>d?-1:0},lowtohigh:function(a,b){var c=Number(a.get("total_payments")),d=Number(b.get("total_payments"));return d>c?-1:c>d?1:0},getUniqueValuesForAttr:function(a){return _.compact(_.uniq(this.map(function(b){return b.get(a)})))}}),e=Backbone.Model.extend({}),f=Backbone.Collection.extend({model:e,comparator:"last"}),g=Backbone.Model.extend({}),e=(Backbone.Collection.extend({model:g,comparator:"neighborhood"}),Backbone.Model.extend({})),f=Backbone.Collection.extend({model:e}),h=Backbone.View.extend({cases:new d,initialize:function(){return Backbone.View.prototype.initialize.apply(this,arguments),this.template=_.template(a("#case-tmpl").html()),this.cases.on("reset",this.render.bind(this)),this.listSorter=new m({caseList:this,el:"#case-list-sort"}),this},render:function(){var a=this,b="";return this.$el.html(""),this.cases.each(function(c){b+=a.template({model:c.toJSON()})}),this.$el.html(b),this},formatStr:function(a){var b="";return b=a.match(/^(\r\n|.){1,280}\b/g).join("")," "==b.substring(b.length-1)&&(b=b.substring(0,b.length-1)),","==b.substring(b.length-1)&&(b=b.substring(0,b.length-1)),"-"==b.substring(b.length-1)&&(b=b.substring(0,b.length-1)),b+='...<span class="read-more">Read More &raquo; </span>'}}),i=Backbone.View.extend({officers:new f,initialize:function(){return Backbone.View.prototype.initialize.apply(this,arguments),this.template=_.template(a("#officer-tmpl").html()),this.officers.on("reset",this.render.bind(this)),this},render:function(){var a=this,b="";return this.$el.html(""),this.officers.each(function(c){b+=a.template({model:c.toJSON()})}),this.$el.html(b),this}}),j=Backbone.View.extend({initialize:function(a){return Backbone.View.prototype.initialize.apply(this,arguments),this.officerList=a.officerList,this.officers=a.officers,this.initTypeahead(),this},initTypeahead:function(){var a=new Bloodhound({local:this.officers.toJSON(),queryTokenizer:Bloodhound.tokenizers.whitespace,datumTokenizer:Bloodhound.tokenizers.obj.whitespace(["first","last","prefix","badge_number"])});this.$el.find(".typeahead").typeahead({minLength:3,highlight:!0},{name:"officers",display:function(a){var b=a.prefix+" "+a.first+" "+a.last;return a.badge_number&&(b+=" (badge: "+a.badge_number+")"),b},source:a}),this.$el.find(".typeahead").on("typeahead:select",this.filterOfficers.bind(this))},filterOfficers:function(b,c){var d=this.officers.findWhere(c);this.officerList.officers.reset([d]);var e=a(".detail-page");e&&(a(".detail-wrapper").hide(),a(".officer-list, .results-wrapper-inner").show())},filterCases:function(a,b){var c=b.case_numbers,d=this.cases.filter(function(a){return c.indexOf(a.get("case_number"))>=0?a:void 0});this.caseList.cases.reset(d)}}),k=Backbone.View.extend({initialize:function(b){return Backbone.View.prototype.initialize.apply(this,arguments),this.filterData=b.filterData,this.template=_.template(a("#case-search-statement-tmpl").html()),this.caseList=b.caseList,this},render:function(){if("undefined"==typeof this.filterData)return!1;var b=_.extend(this.filterData,{incidents:this.caseList.cases.length,payments:this.caseList.cases.reduce(function(a,b){return a+b.get("total_payments")},0)}),c=this.template(b);this.$el.html(c.trim()+"."),a("#search-intro").hide()}}),l=Backbone.View.extend({events:{"change :input":"handleChange"},initialize:function(a){return Backbone.View.prototype.initialize.apply(this,arguments),this.filterData=this.$el.serializeObject(),this.cases=a.cases,this.caseList=a.caseList,this.initChosen(),this.initTags(),this},handleChange:function(){this.filterData=this.$el.serializeObject(),this.filterCases(),this.updateStatement()},updateStatement:function(){"undefined"==typeof this.caseSearchStatement&&(this.caseSearchStatement=new k({filterdata:this.filterData,el:"#case-search-statement",caseList:this.caseList})),this.caseSearchStatement.filterData=this.filterData,this.caseSearchStatement.render()},filterCases:function(){var b=this,c=[];this.cases.each(function(a){var d=!0;_.each(b.filterData,function(b,c){if(""!=b){if(["neighborhood"].indexOf(c)>=0&&"neighborhood"==c&&("unknown"==b?"undefined"!=typeof a.get(c)&&(d=!1):a.get(c)!==b&&(d=!1)),"total_payments"==c){var e=b.split("-"),f=Number(e[0]),g=Number(e[1]),h=Number(a.get("total_payments"));h>=f&&g>=h||(d=!1)}if("primary_causes"==c&&b.indexOf(a.get("primary_cause"))<0&&(d=!1),"tags"==c){var i=a.get("tags").toLowerCase();i.indexOf(b)<0&&(d=!1)}}}),d&&c.push(a)}),this.caseList.cases.reset(c);var d=a(".detail-page");d&&(a(".detail-wrapper").hide(),a(".case-list, .results-wrapper-inner").show(),a(".search-statement-wrapper").show())},initChosen:function(){this.$el.find("select.chosen").chosen()},initTags:function(){a("#tag-toggle").click(function(){a(this).toggleClass("expanded"),a("#tag-group").slideToggle()})}}),m=Backbone.View.extend({initialize:function(a){return this.$el.chosen({width:"200px",disable_search:!0}),this.caseList=a.caseList,this.caseList.cases.on("sort",this.caseList.render.bind(this.caseList)),Backbone.View.prototype.initialize.apply(this,arguments),this},events:{change:"sortCaseList"},sortCaseList:function(b){var c=a(b.currentTarget).val();switch(c){case"payment-low-high":this.caseList.cases.comparator=this.caseList.cases.lowtohigh;break;case"payment-high-low":this.caseList.cases.comparator=this.caseList.cases.hightolow;break;default:this.caseList.cases.comparator=this.caseList.cases.hightolow}this.caseList.cases.sort()}}),n=Backbone.View.extend({events:{"click .tab-selector a":"goToTab"},initialize:function(a){return this.cases=a.cases,this.caseList=a.caseList,this.officers=a.officers,this.officerList=a.officerList,Backbone.View.prototype.initialize.apply(this,arguments),this},goToTab:function(b,c){var d;return"string"==typeof b?(d="search/"+b,this.$el.find(".tab-selector li").removeClass("active"),this.$el.find(".tab-selector li."+b).addClass("active")):(d=a(b.currentTarget).attr("href").replace(Backbone.history.root,""),a(b.currentTarget).siblings().removeClass("active"),a(b.currentTarget).addClass("active")),this.$el.find(".tab-containers > .tab-container").hide(),this.$el.find('[data-tab-id="'+b+'"]').show(),"cases"==b?("undefined"==typeof this.caseForm&&(this.caseForm=new l({el:"#case-search-form",cases:this.cases,caseList:this.caseList})),this.caseForm.filterCases()):"undefined"==typeof this.officerForm&&(this.officerForm=new j({el:"#officer-search-form",officers:this.officers,officerList:this.officerList})),c?void a(".detail-wrapper").show():(a(".detail-wrapper").hide(),Backbone.history.navigate(d,{trigger:!0}),!1)}});Number.prototype.formatMoney=function(a,b,c){var d=this,a=isNaN(a=Math.abs(a))?2:a,b=void 0==b?".":b,c=void 0==c?",":c,e=0>d?"-":"",f=parseInt(d=Math.abs(+d||0).toFixed(a))+"",g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+c:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+c)+(a?b+Math.abs(d-f).toFixed(a).slice(2):"")},a(document).ready(function(){window.router=new b,Backbone.history.start({pushState:!0,root:site_path})})}();